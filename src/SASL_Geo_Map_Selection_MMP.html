<!DOCTYPE html>
<html lang="en">
<!-- Original 1st edition SASL file by Steve P. Inman -->
<!-- Modified by Don Lazov 8/8/2025 -->
<!-- Updated to use the 2nd edition SASL tables, updated to use the geo maps 1 through 92 and SK boards g-h (21) -->
<!-- Also added North/South Map alignment -->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SASL Geo Map Selection Utility - MMP</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      padding: 0;
      background-color: #f9f9f9;
    }

    h1 {
      text-align: center;
      color: #333;
    }

    h2 {
      text-align: center;
      color: #333;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    select,
    button {
      display: block;
      margin: 10px 0;
      padding: 10px;
      font-size: 16px;
      width: 100%;
    }

    button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }

    button:hover {
      background-color: #0056b3;
    }

    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
    }

    table,
    th,
    td {
      border: 1px solid #ddd;
    }

    th,
    td {
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f8f9fa;
    }

    .reroll-btn {
      background-color: #28a745;
      color: white;
      padding: 5px 10px;
      border: none;
      cursor: pointer;
    }

    .reroll-btn:hover {
      background-color: #218838;
    }

    .river-text {
      color: #003366;
      font-weight: bold;
    }

    .mated-board {
      font-weight: bold;
    }

    .dw-indicator {
      color: #666666;
      font-weight: bold;
      font-style: italic;
      margin-left: 4px;
    }

    .filter-section {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 5px;
      border: 1px solid #ddd;
    }

    .filter-section h3 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #333;
      font-size: 16px;
    }

    .checkbox-label {
      display: inline-block;
      margin-right: 15px;
      margin-bottom: 5px;
      cursor: pointer;
      font-weight: normal;
    }

    .checkbox-label input[type="checkbox"] {
      margin-right: 5px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>SASL Geo Map Selection Utility</h1>
    <h2>MMP</h2>

    <div class="filter-section">
      <h3>Map Filters:</h3>
      <label class="checkbox-label">
        <input type="checkbox" id="include-dw" checked>
        <span class="checkmark"></span>
        DW
      </label>
      <label class="checkbox-label">
        <input type="checkbox" id="include-rivers" checked>
        <span class="checkmark"></span>
        Rivers
      </label>
    </div>

    <label for="board-count">Select Number of Boards:</label>
    <select id="board-count">
      <option value="1" selected>1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
      <option value="7">7</option>
      <option value="8">8</option>
      <option value="9">9</option>
      <option value="10">10</option>
    </select>

    <label for="terrain-category">Select Terrain Category:</label>
    <select id="terrain-category"></select>

    <label for="drm">Terrain Selection Dice Roll Modifier (DRM):</label>
    <select id="drm">
      <option value="-2">-2</option>
      <option value="-1">-1</option>
      <option value="0" selected>0</option>
      <option value="1">+1</option>
      <option value="2">+2</option>
    </select>

    <label for="drm2">Mapboard Number Selection Dice Roll Modifier (DRM):</label>
    <select id="drm2">
      <option value="-2">-2</option>
      <option value="-1">-1</option>
      <option value="0" selected>0</option>
      <option value="1">+1</option>
      <option value="2">+2</option>
    </select>

    <button onclick="generateTerrain()">Generate Terrain</button>

    <table id="results">
      <thead>
        <tr>
          <th>Board</th>
          <th>Terrain Type</th>
          <th>Mapboard #</th>
          <th>Map Alignment</th>
          <th>Reroll Mapboard #</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const TableA8 = `<?xml version="1.0" encoding="UTF-8"?>
<TerrainSelection>
  <Column name="Standard A8a">
    <Row minRoll="2" maxRoll="2" terrainType="City"/>
    <Row minRoll="3" maxRoll="5" terrainType="Village"/>
    <Row minRoll="6" maxRoll="7" terrainType="Farmland"/>
    <Row minRoll="8" maxRoll="9" terrainType="Rural"/>
    <Row minRoll="10" maxRoll="12" terrainType="Hills"/>
  </Column>
  <Column name="Urban A8b">
    <Row minRoll="2" maxRoll="5" terrainType="City"/>
    <Row minRoll="6" maxRoll="12" terrainType="Village"/>
  </Column>
  <Column name="Country A8c">
    <Row minRoll="2" maxRoll="6" terrainType="Farmland"/>
    <Row minRoll="7" maxRoll="9" terrainType="Rural"/>
    <Row minRoll="10" maxRoll="12" terrainType="Hills"/>
  </Column>
  <Column name="Country A8d">
	<Row minRoll="2" maxRoll="5" terrainType="Village"/>
    <Row minRoll="6" maxRoll="8" terrainType="Rural"/>
	<Row minRoll="9" maxRoll="12" terrainType="Farmland"/>
  </Column>
  <Column name="Country A8e">
	<Row minRoll="2" maxRoll="4" terrainType="Village"/>
    <Row minRoll="5" maxRoll="7" terrainType="Farmland"/>
    <Row minRoll="8" maxRoll="9" terrainType="Rural"/>
    <Row minRoll="10" maxRoll="12" terrainType="Hills"/>
  </Column>
  <!-- Add other columns as needed -->
</TerrainSelection>
    `;

  const TableA9 = `<?xml version="1.0" encoding="UTF-8"?>
<MapboardSelection>
  <Column name="City">
    <Row roll="1" MapboardNumber="1"/>
    <Row roll="2" MapboardNumber="20"/>
    <Row roll="3" MapboardNumber="21"/>
    <Row roll="4" MapboardNumber="22"/>
    <Row roll="5" MapboardNumber="23 (river)"/>
    <Row roll="6" MapboardNumber="45"/>
    <Row roll="7" MapboardNumber="49"/>
    <Row roll="8" MapboardNumber="51"/>
    <Row roll="9" MapboardNumber="60"/>
    <Row roll="10" MapboardNumber="64 (mates with 65)"/>
    <Row roll="11" MapboardNumber="65 (mates with 64)"/>
    <Row roll="12" MapboardNumber="68"/>
    <Row roll="13" MapboardNumber="76"/>
    <Row roll="14" MapboardNumber="92"/>
    <Row roll="15" MapboardNumber="j"/>
    <Row roll="16" MapboardNumber="k"/>
    <Row roll="17" MapboardNumber="r"/>
    <Row roll="18" MapboardNumber="s"/>
    <Row roll="19" MapboardNumber="y"/>
    <Row roll="20" MapboardNumber="z"/>
    <Row roll="21" MapboardNumber="1"/>
    <Row roll="22" MapboardNumber="20"/>
    <Row roll="23" MapboardNumber="21"/>
    <Row roll="24" MapboardNumber="22"/>
    <Row roll="25" MapboardNumber="23 (river)"/>
    <Row roll="26" MapboardNumber="45"/>
    <Row roll="27" MapboardNumber="49"/>
    <Row roll="28" MapboardNumber="51"/>
    <Row roll="29" MapboardNumber="60"/>
    <Row roll="30" MapboardNumber="64 (mates with 65)"/>
    <Row roll="31" MapboardNumber="65 (mates with 64)"/>
    <Row roll="32" MapboardNumber="68"/>
    <Row roll="33" MapboardNumber="76"/>
    <Row roll="34" MapboardNumber="92"/>
    <Row roll="35" MapboardNumber="j"/>
    <Row roll="36" MapboardNumber="k"/>
    <Row roll="37" MapboardNumber="r"/>
    <Row roll="38" MapboardNumber="s"/>
    <Row roll="39" MapboardNumber="y"/>
    <Row roll="40" MapboardNumber="z"/>
    <Row roll="41" MapboardNumber="45"/>
    <Row roll="42" MapboardNumber="49"/>
    <Row roll="43" MapboardNumber="51"/>
    <Row roll="44" MapboardNumber="60"/>
    <Row roll="45" MapboardNumber="68"/>
    <Row roll="46" MapboardNumber="76"/>
    <Row roll="47" MapboardNumber="92"/>
    <Row roll="48" MapboardNumber="s"/>
  </Column>
  <Column name="Village">
    <Row roll="1" MapboardNumber="3"/>
    <Row roll="2" MapboardNumber="8 (river)"/>
    <Row roll="3" MapboardNumber="10"/>
    <Row roll="4" MapboardNumber="10z"/>
    <Row roll="5" MapboardNumber="12"/>
    <Row roll="6" MapboardNumber="17"/>
    <Row roll="7" MapboardNumber="17z"/>
    <Row roll="8" MapboardNumber="24"/>
    <Row roll="9" MapboardNumber="41"/>
    <Row roll="10" MapboardNumber="42"/>
    <Row roll="11" MapboardNumber="43"/>
    <Row roll="12" MapboardNumber="46"/>
    <Row roll="13" MapboardNumber="48"/>
    <Row roll="14" MapboardNumber="49"/>
    <Row roll="15" MapboardNumber="53"/>
    <Row roll="16" MapboardNumber="56"/>
    <Row roll="17" MapboardNumber="57"/>
    <Row roll="18" MapboardNumber="59"/>
    <Row roll="19" MapboardNumber="60"/>
    <Row roll="20" MapboardNumber="62"/>	
    <Row roll="21" MapboardNumber="63"/>
    <Row roll="22" MapboardNumber="64 (mates with 65)"/>
    <Row roll="23" MapboardNumber="65 (mates with 64)"/>
    <Row roll="24" MapboardNumber="66"/>
    <Row roll="25" MapboardNumber="67"/>
    <Row roll="26" MapboardNumber="68"/>
    <Row roll="27" MapboardNumber="70"/>
    <Row roll="28" MapboardNumber="71"/>
    <Row roll="29" MapboardNumber="76"/>
    <Row roll="30" MapboardNumber="79 (river)"/>
    <Row roll="31" MapboardNumber="86"/>
    <Row roll="32" MapboardNumber="89"/>
    <Row roll="33" MapboardNumber="92"/>
    <Row roll="34" MapboardNumber="g"/>
    <Row roll="35" MapboardNumber="i"/>
    <Row roll="36" MapboardNumber="m"/>
    <Row roll="37" MapboardNumber="p"/>
    <Row roll="38" MapboardNumber="q"/>
    <Row roll="39" MapboardNumber="r"/>
    <Row roll="40" MapboardNumber="s"/>
    <Row roll="41" MapboardNumber="u"/>
    <Row roll="42" MapboardNumber="w"/>
    <Row roll="43" MapboardNumber="y"/>
    <Row roll="44" MapboardNumber="z"/>
    <Row roll="45" MapboardNumber="10z"/>
    <Row roll="46" MapboardNumber="17z"/>
    <Row roll="47" MapboardNumber="67"/>
    <Row roll="48" MapboardNumber="86"/>
  </Column>
  <Column name="Farmland">
    <Row roll="1" MapboardNumber="4"/>
    <Row roll="2" MapboardNumber="6"/>
    <Row roll="3" MapboardNumber="7 (river)"/>
    <Row roll="4" MapboardNumber="11"/>
    <Row roll="5" MapboardNumber="13"/>
    <Row roll="6" MapboardNumber="14"/>
    <Row roll="7" MapboardNumber="16"/>
    <Row roll="8" MapboardNumber="17"/>
    <Row roll="9" MapboardNumber="17z"/>
    <Row roll="10" MapboardNumber="19"/>
    <Row roll="11" MapboardNumber="33"/>
    <Row roll="12" MapboardNumber="35"/>
    <Row roll="13" MapboardNumber="38"/>
    <Row roll="14" MapboardNumber="40 (river)"/>
    <Row roll="15" MapboardNumber="42"/>
    <Row roll="16" MapboardNumber="43"/>
    <Row roll="17" MapboardNumber="44"/>
    <Row roll="18" MapboardNumber="46"/>
    <Row roll="19" MapboardNumber="48"/>
    <Row roll="20" MapboardNumber="53"/>
    <Row roll="21" MapboardNumber="54"/>
    <Row roll="22" MapboardNumber="56"/>
    <Row roll="23" MapboardNumber="57"/>
    <Row roll="24" MapboardNumber="59"/>
    <Row roll="25" MapboardNumber="62"/>
    <Row roll="26" MapboardNumber="63"/>
    <Row roll="27" MapboardNumber="66"/>
    <Row roll="28" MapboardNumber="69"/>
    <Row roll="29" MapboardNumber="70"/>
    <Row roll="30" MapboardNumber="71"/>
    <Row roll="31" MapboardNumber="72"/>
    <Row roll="32" MapboardNumber="73"/>
    <Row roll="33" MapboardNumber="85"/>
    <Row roll="34" MapboardNumber="89"/>
    <Row roll="35" MapboardNumber="90"/>
    <Row roll="36" MapboardNumber="g"/>
    <Row roll="37" MapboardNumber="h"/>
    <Row roll="38" MapboardNumber="i"/>
    <Row roll="39" MapboardNumber="l"/>
    <Row roll="40" MapboardNumber="m"/>
    <Row roll="41" MapboardNumber="p"/>
    <Row roll="42" MapboardNumber="t"/>
    <Row roll="43" MapboardNumber="v"/>
    <Row roll="44" MapboardNumber="x"/>
    <Row roll="45" MapboardNumber="y"/>
    <Row roll="46" MapboardNumber="17z"/>
    <Row roll="47" MapboardNumber="59"/>
    <Row roll="48" MapboardNumber="90"/>
  </Column>
  <Column name="Rural">
    <Row roll="1" MapboardNumber="4"/>
    <Row roll="2" MapboardNumber="5"/>
    <Row roll="3" MapboardNumber="7 (river)"/>
    <Row roll="4" MapboardNumber="11"/>
    <Row roll="5" MapboardNumber="13"/>
    <Row roll="6" MapboardNumber="14"/>
    <Row roll="7" MapboardNumber="16"/>
    <Row roll="8" MapboardNumber="17"/>
    <Row roll="9" MapboardNumber="18"/>
    <Row roll="10" MapboardNumber="19"/>
    <Row roll="11" MapboardNumber="32"/>
    <Row roll="12" MapboardNumber="33"/>
    <Row roll="13" MapboardNumber="34"/>
    <Row roll="14" MapboardNumber="35"/>
    <Row roll="15" MapboardNumber="36"/>
    <Row roll="16" MapboardNumber="37"/>
    <Row roll="17" MapboardNumber="38"/>
    <Row roll="18" MapboardNumber="40 (river)"/>
    <Row roll="19" MapboardNumber="42"/>
    <Row roll="20" MapboardNumber="43"/>
    <Row roll="21" MapboardNumber="44"/>
    <Row roll="22" MapboardNumber="47"/>
    <Row roll="23" MapboardNumber="50"/>
    <Row roll="24" MapboardNumber="52"/>
    <Row roll="25" MapboardNumber="54"/>
    <Row roll="26" MapboardNumber="55"/>
    <Row roll="27" MapboardNumber="61"/>
    <Row roll="28" MapboardNumber="62"/>
    <Row roll="29" MapboardNumber="66"/>
    <Row roll="30" MapboardNumber="69"/>
    <Row roll="31" MapboardNumber="70"/>
    <Row roll="32" MapboardNumber="72"/>
    <Row roll="33" MapboardNumber="73"/>
    <Row roll="34" MapboardNumber="74"/>
    <Row roll="35" MapboardNumber="75"/>
    <Row roll="36" MapboardNumber="77"/>
    <Row roll="37" MapboardNumber="84"/>
    <Row roll="38" MapboardNumber="85"/>
    <Row roll="39" MapboardNumber="90"/>
    <Row roll="40" MapboardNumber="91"/>
    <Row roll="41" MapboardNumber="93"/>
    <Row roll="42" MapboardNumber="h"/>
    <Row roll="43" MapboardNumber="l"/>
    <Row roll="44" MapboardNumber="n"/>
    <Row roll="45" MapboardNumber="o"/>
    <Row roll="46" MapboardNumber="t"/>
    <Row roll="47" MapboardNumber="u"/>
    <Row roll="48" MapboardNumber="x"/>	
  </Column>
  <Column name="Hills">
    <Row roll="1" MapboardNumber="2"/>
    <Row roll="2" MapboardNumber="3"/>
    <Row roll="3" MapboardNumber="8 (river)"/>
    <Row roll="4" MapboardNumber="9"/>
    <Row roll="5" MapboardNumber="11"/>
    <Row roll="6" MapboardNumber="15"/>
    <Row roll="7" MapboardNumber="18"/>
    <Row roll="8" MapboardNumber="25"/>
    <Row roll="9" MapboardNumber="36"/>
    <Row roll="10" MapboardNumber="39"/>
    <Row roll="11" MapboardNumber="40 (river)"/>
    <Row roll="12" MapboardNumber="41"/>
    <Row roll="13" MapboardNumber="47"/>
    <Row roll="14" MapboardNumber="50"/>
    <Row roll="15" MapboardNumber="55"/>
    <Row roll="16" MapboardNumber="58"/>
    <Row roll="17" MapboardNumber="60"/>
    <Row roll="18" MapboardNumber="61"/>
    <Row roll="19" MapboardNumber="77"/>
    <Row roll="20" MapboardNumber="78"/>
    <Row roll="21" MapboardNumber="80 (mates to 81)"/>
    <Row roll="22" MapboardNumber="81 (mates to 80)"/>
    <Row roll="23" MapboardNumber="82 (mates to 83)"/>
    <Row roll="24" MapboardNumber="83 (mates to 82)"/>
    <Row roll="25" MapboardNumber="84"/>
    <Row roll="26" MapboardNumber="86"/>
    <Row roll="27" MapboardNumber="87 (mates to 88)"/>
    <Row roll="28" MapboardNumber="88 (mates to 87)"/>
    <Row roll="29" MapboardNumber="92"/>
    <Row roll="30" MapboardNumber="h"/>
    <Row roll="31" MapboardNumber="o"/>
    <Row roll="32" MapboardNumber="p"/>
    <Row roll="33" MapboardNumber="u"/>
    <Row roll="34" MapboardNumber="v"/>
    <Row roll="35" MapboardNumber="w"/>
    <Row roll="36" MapboardNumber="2"/>
    <Row roll="37" MapboardNumber="3"/>
    <Row roll="38" MapboardNumber="9"/>
    <Row roll="39" MapboardNumber="11"/>
    <Row roll="40" MapboardNumber="18"/>
    <Row roll="41" MapboardNumber="41"/>
    <Row roll="42" MapboardNumber="50"/>
    <Row roll="43" MapboardNumber="61"/>
    <Row roll="44" MapboardNumber="77"/>
    <Row roll="45" MapboardNumber="78"/>
    <Row roll="46" MapboardNumber="h"/>
    <Row roll="47" MapboardNumber="o"/>
    <Row roll="48" MapboardNumber="p"/>
  </Column>
</MapboardSelection>`;

    let terrainData = [];

    // Parse XML and populate dropdown
    function parseXML() {
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(TableA8, "text/xml");
      const columns = xmlDoc.getElementsByTagName("Column");

      const dropdown = document.getElementById("terrain-category");
      for (const column of columns) {
        const name = column.getAttribute("name");
        const rows = Array.from(column.getElementsByTagName("Row")).map(row => ({
          minRoll: parseInt(row.getAttribute("minRoll")),
          maxRoll: parseInt(row.getAttribute("maxRoll")),
          terrainType: row.getAttribute("terrainType")
        }));
        terrainData.push({ name, rows });

        const option = document.createElement("option");
        option.value = name;
        option.textContent = name;
        dropdown.appendChild(option);
      }
    }

    // Generate terrain for selected boards
    function generateTerrain() {
      const category = document.getElementById("terrain-category").value;
      const boardCount = parseInt(document.getElementById("board-count").value);
      const drm = parseInt(document.getElementById("drm").value);
      const drm2 = parseInt(document.getElementById("drm2").value); // Mapboard DRM
      const selectedCategory = terrainData.find(cat => cat.name === category);

      if (!selectedCategory) {
        alert("Please select a valid terrain category.");
        return;
      }

      const resultsTable = document.getElementById("results").querySelector("tbody");
      resultsTable.innerHTML = ""; // Clear previous results

      let currentBoardNumber = 1;
      let boardsAdded = 0;
      
      while (boardsAdded < boardCount) {
        const initialRowCount = resultsTable.rows.length;
        addBoardRow(currentBoardNumber, selectedCategory, drm, drm2);
        const rowsAdded = resultsTable.rows.length - initialRowCount;
        
        boardsAdded += rowsAdded;
        currentBoardNumber += rowsAdded;
      }
    }

    // Add a row to the results table
    function addBoardRow(boardNumber, selectedCategory, drm, drm2) {
      const roll = roll2D6() + drm;
      const clampedRoll = Math.max(2, Math.min(roll, 12));
      const terrain = selectedCategory.rows.find(row => clampedRoll >= row.minRoll && clampedRoll <= row.maxRoll);
      const terrainType = terrain ? terrain.terrainType : "Unknown";

      // For mapboard selection, we need to roll a d48 (or simulate it with appropriate dice)
      const mapboardRoll = rollD48() + drm2;
      const clampedRoll2 = Math.max(1, Math.min(mapboardRoll, 48));
      let mapboardNumber = terrainType !== "Unknown"
        ? getMapboardNumber(TableA9, terrainType, clampedRoll2)
        : "N/A";

      // Apply filters
      const includeDW = document.getElementById("include-dw").checked;
      const includeRivers = document.getElementById("include-rivers").checked;
      
      if (!includeDW && (mapboardNumber.includes("(mates with") || mapboardNumber.includes("(mates to"))) {
        // If DW is unchecked and we got a mated board, reroll
        return addBoard(boardNumber);
      }
      
      if (!includeRivers && mapboardNumber.includes("(river)")) {
        // If Rivers is unchecked and we got a river board, reroll
        return addBoard(boardNumber);
      }

      // Check if this mapboard has a mate and get the mate's mapboard number
      let mateMapboardNumber = null;
      let isSpecialMatedPair = false;
      let firstBoard = null;
      let secondBoard = null;
      
      if (mapboardNumber !== "N/A" && (mapboardNumber.includes("(mates to ") || mapboardNumber.includes("(mates with "))) {
        const mateMatch = mapboardNumber.match(/\(mates (?:to|with) (\w+)\)/);
        if (mateMatch) {
          const currentBoard = mapboardNumber.split(' ')[0];
          const mateNumber = mateMatch[1];
          
          // Check for special mated pairs with specific ordering
          const specialPairs = {
            '64': '65', '65': '64',
            '81': '80', '80': '81', 
            '83': '82', '82': '83',
            '87': '88', '88': '87'
          };
          
          if (specialPairs[currentBoard] || specialPairs[mateNumber]) {
            isSpecialMatedPair = true;
            // Determine the correct ordering
            if (['64', '81', '83', '87'].includes(currentBoard)) {
              firstBoard = `${currentBoard} (mates with ${specialPairs[currentBoard]})`;
              secondBoard = `${specialPairs[currentBoard]} (mates with ${currentBoard})`;
            } else if (['65', '80', '82', '88'].includes(currentBoard)) {
              firstBoard = `${specialPairs[currentBoard]} (mates with ${currentBoard})`;
              secondBoard = `${currentBoard} (mates with ${specialPairs[currentBoard]})`;
            } else if (['64', '81', '83', '87'].includes(mateNumber)) {
              firstBoard = `${mateNumber} (mates with ${specialPairs[mateNumber]})`;
              secondBoard = `${specialPairs[mateNumber]} (mates with ${mateNumber})`;
            } else {
              firstBoard = `${specialPairs[mateNumber]} (mates with ${mateNumber})`;
              secondBoard = `${mateNumber} (mates with ${specialPairs[mateNumber]})`;
            }
          } else {
            // Regular mate pair processing
            mateMapboardNumber = `${mateNumber} (mates ${mapboardNumber.includes("to") ? "to" : "with"} ${currentBoard})`;
          }
        }
      }

      // Roll for map alignment (or set to South for special pairs)
      const mapAlignment = isSpecialMatedPair ? "South" : getMapAlignment();

      const resultsTable = document.getElementById("results").querySelector("tbody");
      
      if (isSpecialMatedPair) {
        // Add the first board of the special pair
        const row1 = resultsTable.insertRow();
        row1.innerHTML = `
      <td>${boardNumber}</td>
      <td>${terrainType}</td>
      <td>${formatMapboardNumber(firstBoard)}</td>
      <td>South</td>
      <td><button class="reroll-btn" onclick="reroll(this, ${boardNumber}, '${selectedCategory.name}', ${drm2})">Reroll</button></td>
    `;
        
        // Add the second board of the special pair
        const row2 = resultsTable.insertRow();
        row2.innerHTML = `
      <td>${boardNumber + 1}</td>
      <td>${terrainType}</td>
      <td>${formatMapboardNumber(secondBoard)}</td>
      <td>South</td>
      <td><button class="reroll-btn" onclick="reroll(this, ${boardNumber + 1}, '${selectedCategory.name}', ${drm2})">Reroll</button></td>
    `;
      } else {
        // Regular board processing
        const row = resultsTable.insertRow();
        row.innerHTML = `
      <td>${boardNumber}</td>
      <td>${terrainType}</td>
      <td>${formatMapboardNumber(mapboardNumber)}</td>
      <td>${mapAlignment}</td>
      <td><button class="reroll-btn" onclick="reroll(this, ${boardNumber}, '${selectedCategory.name}', ${drm2})">Reroll</button></td>
    `;

        // If there's a regular mate mapboard, automatically add it as the next board
        if (mateMapboardNumber) {
          const mateAlignment = getMapAlignment();
          const mateRow = resultsTable.insertRow();
          
          mateRow.innerHTML = `
        <td>${boardNumber + 1}</td>
        <td>${terrainType}</td>
        <td>${formatMapboardNumber(mateMapboardNumber)}</td>
        <td>${mateAlignment}</td>
        <td><button class="reroll-btn" onclick="reroll(this, ${boardNumber + 1}, '${selectedCategory.name}', ${drm2})">Reroll</button></td>
      `;
        }
      }
    }



    // Reroll for a specific row
    function reroll(button, boardNumber, categoryName, drm2) {
      // Fetch the row where the reroll is happening
      const row = button.parentElement.parentElement;

      // Fetch the current terrain type from the row
      const terrainType = row.cells[1].textContent;

      if (terrainType === "Unknown") {
        alert("Cannot reroll for an unknown terrain type.");
        return;
      }

      // Perform the mapboard roll using drm2 with d48
      const roll2 = rollD48() + drm2;
      const clampedRoll2 = Math.max(1, Math.min(roll2, 48));

      // Lookup the mapboard number for the current terrain type
      const mapboardNumber = getMapboardNumber(TableA9, terrainType, clampedRoll2);

      // Roll for new map alignment
      const mapAlignment = getMapAlignment();

      // Update the mapboard number and map alignment in the table
      row.cells[2].innerHTML = formatMapboardNumber(mapboardNumber);
      row.cells[3].textContent = mapAlignment;
    }

    // Simulate a 2D6 roll
    function roll2D6() {
      return Math.floor(Math.random() * 6 + 1) + Math.floor(Math.random() * 6 + 1);
    }

    // Simulate a D6 roll (1-6) for map alignment
    function rollD6() {
      return Math.floor(Math.random() * 6) + 1;
    }

    // Simulate a D48 roll (1-48)
    function rollD48() {
      return Math.floor(Math.random() * 48) + 1;
    }

    // Determine map alignment based on D6 roll
    function getMapAlignment() {
      const roll = rollD6();
      return roll <= 3 ? "North" : "South";
    }

    function formatMapboardNumber(mapboardNumber) {
      let formattedText = mapboardNumber;
      let cssClasses = [];
      
      // Check for river boards
      if (mapboardNumber.includes("(river)")) {
        cssClasses.push("river-text");
      }
      
      // Check for mated boards
      if (mapboardNumber.includes("(mates with") || mapboardNumber.includes("(mates to")) {
        cssClasses.push("mated-board");
        
        // Extract the board name (everything before the parentheses)
        const boardName = mapboardNumber.split(' (')[0];
        
        // Apply styling and add DW indicator, but don't include the mate info text
        if (cssClasses.length > 0) {
          formattedText = `<span class="${cssClasses.join(' ')}">${boardName}</span><span class="dw-indicator">DW</span>`;
        } else {
          formattedText = `<span class="mated-board">${boardName}</span><span class="dw-indicator">DW</span>`;
        }
        return formattedText;
      }
      
      // Apply river styling if needed
      if (cssClasses.length > 0) {
        formattedText = `<span class="${cssClasses.join(' ')}">${mapboardNumber}</span>`;
      }
      
      return formattedText;
    }

    function getMapboardNumber(xmlString, columnName, roll) {
      // Parse the XML string into a DOM object
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(xmlString, "application/xml");

      // Find the specified column by its name attribute
      const column = xmlDoc.querySelector(`Column[name="${columnName}"]`);
      if (!column) {
        throw new Error(`Column with name "${columnName}" not found.`);
      }

      // Find the row with the specified roll attribute within the column
      const row = column.querySelector(`Row[roll="${roll}"]`);
      if (!row) {
        throw new Error(`Row with roll "${roll}" not found in column "${columnName}".`);
      }

      // Return the MapboardNumber attribute from the row
      return row.getAttribute("MapboardNumber");
    }

    // Initialize
    document.addEventListener("DOMContentLoaded", () => {
      parseXML();
    });

  </script>
</body>

</html>